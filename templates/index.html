<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Quant Analyst | ìŠ¤ìœ™ íŠ¸ë ˆì´ë”© ëŒ€ì‹œë³´ë“œ</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Lightweight Charts (TradingView) -->
    <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        .chart-container {
            position: relative;
        }

        .chart-tooltip {
            width: 160px;
            position: absolute;
            display: none;
            padding: 10px;
            box-sizing: border-box;
            font-size: 13px;
            text-align: left;
            z-index: 1000;
            top: 12px;
            left: 12px;
            pointer-events: none;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: rgba(21, 26, 37, 0.9);
            backdrop-filter: blur(4px);
            color: var(--text-primary);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        .chart-tooltip div {
            margin: 3px 0;
        }

        .chart-tooltip .title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 6px;
        }

        /* ìˆ˜ê¸‰ í…Œì´ë¸” ë””ìì¸ */
        .supply-container {
            margin-top: 1.5rem;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 8px;
            padding: 1rem;
            display: none;
        }

        .supply-title {
            margin-bottom: 0.8rem;
            color: var(--text-secondary);
            font-size: 0.95rem;
            letter-spacing: 1px;
        }

        .supply-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            text-align: right;
        }

        .supply-table th,
        .supply-table td {
            padding: 8px 4px;
            border-bottom: 1px solid var(--border-color);
        }

        .supply-table th {
            text-align: right;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .supply-table th:first-child,
        .supply-table td:first-child {
            text-align: left;
        }

        .supply-table-wide {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            text-align: right;
            white-space: nowrap;
        }

        .supply-table-wide th,
        .supply-table-wide td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .supply-table-wide th {
            text-align: center;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .supply-table-wide th:first-child,
        .supply-table-wide td:first-child {
            text-align: center;
        }

        .text-danger {
            color: #ff3366;
        }

        .text-success {
            color: #00ff88;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>AI Quant Analyst</h1>
            <div style="color: var(--text-secondary); font-size: 0.9rem;">v1.0 (ë¯¸ì‹œì  ìŠ¤ìœ™ ë·°ì–´)</div>
        </header>

        <section class="search-section" style="display: flex; gap: 10px;">
            <select id="modeSelect"
                style="padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-primary); outline: none;">
                <option value="swing">ğŸ”¥ ìŠ¤ìœ™ ëˆŒë¦¼ëª© (VCP/MACD)</option>
                <option value="atr">ğŸš¨ ATR ê³¼ì—´/ì¹¨ì²´ íŒë…ëŒ€</option>
                <option value="fibonacci">ğŸ“ í”¼ë³´ë‚˜ì¹˜ ë˜ëŒë¦¼ ë¶„ì„</option>
            </select>
            <input type="text" id="tickerInput" style="flex:1;" placeholder="ì¢…ëª© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 005930, 035420, TSLA)..."
                autocomplete="off" onkeypress="if(event.key === 'Enter') analyzeStock()">
            <button onclick="analyzeStock()">ë¶„ì„ ì‹œì‘ ğŸš€</button>
        </section>

        <div id="loadingIndicator" class="loading">
            ë°ì´í„° ìš°ì£¼ë¥¼ ìŠ¤ìº”í•˜ëŠ” ì¤‘... ğŸ“¡
        </div>

        <main id="dashboardGrid" class="dashboard-grid">
            <!-- Left col: Chart -->
            <div class="card">
                <h2 style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <span id="chartTitle">TSLA ì¼ë´‰ ì°¨íŠ¸</span>
                    <div style="display: flex; gap: 0.8rem; font-size: 0.85rem; color: var(--text-secondary);">
                        <label style="cursor: pointer;"><input type="checkbox" id="toggleEma" checked
                                onchange="toggleIndicators()"> EMA ë¼ì¸</label>
                        <label style="cursor: pointer;"><input type="checkbox" id="toggleShort" checked
                                onchange="toggleIndicators()"> ğŸŸ© ë‹¨ê¸°</label>
                        <label style="cursor: pointer;"><input type="checkbox" id="toggleMacd" checked
                                onchange="toggleIndicators()"> ğŸ”µ MACD</label>
                        <label style="cursor: pointer;"><input type="checkbox" id="toggleVcp" checked
                                onchange="toggleIndicators()"> ğŸŸ£ VCP</label>
                    </div>
                </h2>
                <div id="tvchart" class="chart-container">
                    <div id="chartTooltip" class="chart-tooltip"></div>
                </div>
            </div>

            <!-- Right col: Analysis -->
            <div class="analysis-sidebar">
                <div class="card score-box">
                    <h3>í˜„ì¬ ê¸°ìˆ ì  ìŠ¤ìœ™ ì ìˆ˜</h3>
                    <div id="scoreValue" class="score-circle">--</div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">100ì  ë§Œì  ê¸°ì¤€</div>
                </div>

                <div class="card" style="flex: 1;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--text-secondary); letter-spacing: 1px;">ì•Œê³ ë¦¬ì¦˜ ë¶„ì„ì˜ê²¬</h3>
                    <ul id="signalList" class="signal-list">
                        <!-- Signals will be injected here -->
                    </ul>

                    <div class="macro-section" id="macroStatus" style="margin-top:20px;">
                        ê±°ì‹œì  ìƒíƒœ: ëŒ€ê¸°ì¤‘...
                    </div>
                </div>
            </div>

            <!-- í•˜ë‹¨ ì „ì²´ í™•ì¥: ìˆ˜ê¸‰ ë°ì´í„° -->
            <div id="supplyContainer" class="card" style="grid-column: 1 / -1; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ğŸ¦ íˆ¬ììë³„ ë§¤ë§¤ë™í–¥ ë° ê³µë§¤ë„ (KIS API)</h3>
                    <div id="shortBalanceInfo" style="font-size: 0.9em; color: var(--text-secondary);"></div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="supply-table-wide" id="supplyTable">
                        <thead>
                            <tr>
                                <th>ì¼ì</th>
                                <th>ê°œì¸ ìˆœë§¤ìˆ˜</th>
                                <th>ì™¸êµ­ì¸ ìˆœë§¤ìˆ˜</th>
                                <th>ê¸°ê´€ ìˆœë§¤ìˆ˜</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- í•˜ë‹¨ ê°€ì´ë“œë¶ íŒ¨ë„ -->
        <div class="card" style="margin-top: 25px; transition: all 0.3s ease;">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;"
                onclick="toggleGuide()">
                <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                    <span>ğŸ“–</span> <span>ì§€í‘œ ì™„ì „ ì •ë³µ ê°€ì´ë“œë¶</span>
                </h3>
                <button id="guideToggleBtn"
                    style="padding: 6px 12px; font-size: 0.85rem; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 6px; cursor: pointer;">ì ‘ê¸°
                    ğŸ”¼</button>
            </div>

            <div id="guideContent"
                style="margin-top: 20px; font-size: 0.95rem; line-height: 1.6; border-top: 1px solid var(--border-color); padding-top: 20px;">
                <!-- JSì—ì„œ ë™ì  ì£¼ì… -->
            </div>
        </div>
    </div>

    <script>
        let chart = null;
        let candleSeries = null;
        let ema21Series = null;
        let ema50Series = null;
        let ema200Series = null;
        let sma50Series = null;
        let currentMarkers = [];
        let globalChartData = [];
        let fibPriceLines = [];

        function initChart() {
            const chartContainer = document.getElementById('tvchart');
            // ì´ë¯¸ ì°¨íŠ¸ê°€ ìˆë‹¤ë©´ ì´ˆê¸°í™”
            if (chart !== null) {
                chart.remove();
            }

            // ì°¨íŠ¸ ê»ë°ê¸°(UI) ìƒì„±
            chart = LightweightCharts.createChart(chartContainer, {
                layout: {
                    background: { type: 'solid', color: '#151a25' },
                    textColor: '#94a3b8',
                },
                grid: {
                    vertLines: { color: '#1e293b' },
                    horzLines: { color: '#1e293b' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#1e293b',
                },
                timeScale: {
                    borderColor: '#1e293b',
                },
            });

            // ìº”ë“¤ì°¨íŠ¸, ì´í‰ì„  ì‹œë¦¬ì¦ˆ ì¶”ê°€ ì¤€ë¹„
            candleSeries = chart.addCandlestickSeries({
                upColor: '#00ff88',
                downColor: '#ff3366',
                borderVisible: false,
                wickUpColor: '#00ff88',
                wickDownColor: '#ff3366',
            });

            ema21Series = chart.addLineSeries({
                color: '#ffaa00',
                lineWidth: 2,
                title: 'EMA 21',
            });

            ema50Series = chart.addLineSeries({
                color: '#00b8ff',
                lineWidth: 1,
                title: 'EMA 50',
            });

            ema200Series = chart.addLineSeries({
                color: '#94a3b8',
                lineWidth: 1,
                title: 'EMA 200',
            });

            sma50Series = chart.addLineSeries({
                color: '#3b82f6',
                lineWidth: 2,
                title: 'SMA 50',
            });

            // íˆ´íŒ(ë§ˆìš°ìŠ¤ í˜¸ë²„) ì´ë²¤íŠ¸ ì„¤ì •
            const toolTip = document.getElementById('chartTooltip');
            chart.subscribeCrosshairMove(param => {
                if (
                    param.point === undefined ||
                    !param.time ||
                    param.point.x < 0 ||
                    param.point.x > chartContainer.clientWidth ||
                    param.point.y < 0 ||
                    param.point.y > chartContainer.clientHeight
                ) {
                    toolTip.style.display = 'none';
                    return;
                }

                // í˜„ì¬ ë§ˆìš°ìŠ¤ê°€ ê°€ë¦¬í‚¤ëŠ” ë‚ ì§œ(time)ì˜ ë°ì´í„° ì°¾ê¸°
                const hoveredData = globalChartData.find(d => d.time === param.time);
                if (hoveredData && (hoveredData.buy_swing_vcp || hoveredData.buy_swing_macd || hoveredData.buy_short)) {
                    let title = '';
                    let titleColor = '';
                    let targetPrice = 0;

                    if (hoveredData.buy_swing_vcp) {
                        title = 'ğŸŸ£ VCP ìŠ¤ìœ™ íƒ€ì ';
                        titleColor = '#b300ff';
                        targetPrice = hoveredData.close + (hoveredData.atr * 3.0);
                    } else if (hoveredData.buy_swing_macd) {
                        title = 'ğŸ”µ MACD ìŠ¤ìœ™ íƒ€ì ';
                        titleColor = '#00b8ff';
                        targetPrice = hoveredData.close + (hoveredData.atr * 2.0);
                    } else {
                        title = 'ğŸŸ© ë‹¨ê¸° ë°˜ë“± íƒ€ì ';
                        titleColor = '#00ff88';
                        targetPrice = hoveredData.close + (hoveredData.atr * 1.5);
                    }

                    toolTip.innerHTML = `
                        <div class="title" style="color: ${titleColor};">${title}</div>
                        <div>ì§„ì…: <b>${hoveredData.close.toFixed(2)}</b></div>
                        <div>ëª©í‘œ: <b>${targetPrice.toFixed(2)}</b></div>
                        <div style="color: #ff3366;">ì†ì ˆ: <b>${hoveredData.stop_price ? hoveredData.stop_price.toFixed(2) : '-'}</b></div>
                    `;

                    toolTip.style.display = 'block';

                    // íˆ´íŒ ìœ„ì¹˜ ì¡°ì • (í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡)
                    const x = param.point.x;
                    const y = param.point.y;
                    let left = x + 15;
                    if (left > chartContainer.clientWidth - 160) {
                        left = x - 175;
                    }
                    toolTip.style.left = left + 'px';
                    toolTip.style.top = Math.max(10, y - 50) + 'px';
                } else {
                    toolTip.style.display = 'none';
                }
            });
        }

        async function analyzeStock() {
            const ticker = document.getElementById('tickerInput').value.trim();
            const mode = document.getElementById('modeSelect').value;
            if (!ticker) return alert('í‹°ì»¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');

            // UI ë³€ê²½ (ë¡œë”©)
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('dashboardGrid').classList.remove('visible');

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker: ticker, mode: mode })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜');
                }

                // UI ì—…ë°ì´íŠ¸ (ê²°ê³¼)
                updateDashboard(data);

            } catch (error) {
                alert(error.message);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        function updateDashboard(data) {
            // ëŒ€ì‹œë³´ë“œ ë¨¼ì € ìŠ¤ë¥´ë¥µ ì¼œê¸° (í¬ê¸° ê³„ì‚°ì„ ìœ„í•´)
            document.getElementById('dashboardGrid').classList.add('visible');

            // ì°¨íŠ¸ ë Œë”ë§
            initChart();

            // í˜¸ë²„ìš© ê¸€ë¡œë²Œ ë°ì´í„° ì €ì¥
            globalChartData = data.chart_data;

            const mainData = data.chart_data.map(d => ({
                time: d.time, open: d.open, high: d.high, low: d.low, close: d.close
            }));
            candleSeries.setData(mainData);

            // ì´ë™í‰ê· ì„  ë°ì´í„° ë§µí•‘
            const ema21Data = data.chart_data.filter(d => d.ema_21 !== null).map(d => ({ time: d.time, value: d.ema_21 }));
            const ema50Data = data.chart_data.filter(d => d.ema_50 !== null).map(d => ({ time: d.time, value: d.ema_50 }));
            const ema200Data = data.chart_data.filter(d => d.ema_200 !== null).map(d => ({ time: d.time, value: d.ema_200 }));
            const sma50Data = data.chart_data.filter(d => d.sma_50 !== null).map(d => ({ time: d.time, value: d.sma_50 }));

            if (ema21Data.length > 0) ema21Series.setData(ema21Data);
            if (ema50Data.length > 0) ema50Series.setData(ema50Data);
            if (ema200Data.length > 0) ema200Series.setData(ema200Data);
            if (sma50Data.length > 0) sma50Series.setData(sma50Data);

            // ë§¤ìˆ˜ íƒ€ì  ë§ˆì»¤(í™”ì‚´í‘œ) ìƒì„± ë¡œì§
            currentMarkers = [];

            // ì´ˆê¸°í™” (ëª¨ë“œ ë³€ê²½ ì‹œ ì”ì—¬ ì„  ì œê±°)
            fibPriceLines.forEach(line => candleSeries.removePriceLine(line));
            fibPriceLines = [];

            // ëª¨ë“œë³„ í™”ë©´ ì»¨íŠ¸ë¡¤
            const mode = data.analysis.mode;
            let titleSuffix = 'ìŠ¤ìœ™íƒ€ì  ë¶„ì„';

            if (mode === 'swing') {
                titleSuffix = 'ìŠ¤ìœ™ (MACD/VCP) ë¶„ì„';
                sma50Series.applyOptions({ visible: false });
                data.chart_data.forEach(d => {
                    if (d.buy_swing_vcp) {
                        currentMarkers.push({ time: d.time, position: 'belowBar', color: '#b300ff', shape: 'arrowUp', text: 'VCP ìŠ¤ìœ™', type: 'vcp' });
                    } else if (d.buy_swing_macd) {
                        currentMarkers.push({ time: d.time, position: 'belowBar', color: '#00b8ff', shape: 'arrowUp', text: 'MACD ìŠ¤ìœ™', type: 'macd' });
                    } else if (d.buy_short) {
                        currentMarkers.push({ time: d.time, position: 'belowBar', color: '#00ff88', shape: 'arrowUp', text: 'ë‹¨ê¸° ì§„ì…', type: 'short' });
                    }
                });
            } else if (mode === 'atr') {
                titleSuffix = 'ATR ê³¼ì—´/ì¹¨ì²´ íŒë…';
                ema21Series.applyOptions({ visible: false });
                ema50Series.applyOptions({ visible: false });
                ema200Series.applyOptions({ visible: false });
                sma50Series.applyOptions({ visible: true });

                // ATR ê·¹ë‹¨ê°’ì— ì (Dot)ì„ ë§ˆì»¤ë¡œ ì°ì–´ì£¼ê¸°
                data.chart_data.forEach(d => {
                    if (d.ext_atr >= 7) {
                        currentMarkers.push({ time: d.time, position: 'aboveBar', color: '#ff3366', shape: 'circle', text: `${d.ext_atr.toFixed(1)}x`, type: 'atr' });
                    } else if (d.ext_atr <= -7) {
                        currentMarkers.push({ time: d.time, position: 'belowBar', color: '#00ff88', shape: 'circle', text: `${d.ext_atr.toFixed(1)}x`, type: 'atr' });
                    }
                });
            } else if (mode === 'fibonacci') {
                titleSuffix = 'í”¼ë³´ë‚˜ì¹˜ ë˜ëŒë¦¼ ë¼ì¸';
                ema21Series.applyOptions({ visible: false });
                ema50Series.applyOptions({ visible: false });
                ema200Series.applyOptions({ visible: false });
                sma50Series.applyOptions({ visible: false });

                const fib = data.analysis.fibonacci;
                if (fib) {
                    const addLine = (price, color, title) => {
                        fibPriceLines.push(candleSeries.createPriceLine({
                            price: price, color: color, lineWidth: 2, lineStyle: LightweightCharts.LineStyle.Dashed, axisLabelVisible: true, title: title
                        }));
                    };
                    addLine(fib.high, '#ff3366', 'ê³ ì  (0)');
                    addLine(fib.fib_236, '#ffaa00', '0.236');
                    addLine(fib.fib_382, '#eab308', '0.382');
                    addLine(fib.fib_500, '#a855f7', '0.500');
                    addLine(fib.fib_618, '#00b8ff', '0.618 ë°©ì–´ì„ ');
                    addLine(fib.low, '#00ff88', 'ì €ì  (1)');
                }
            }

            // í† ê¸€ ìƒíƒœì— ë§ì¶° ì´ˆê¸° ë§ˆì»¤ ë Œë”ë§ (ì²´í¬ë°•ìŠ¤ í•„í„°ë§ì€ swing ëª¨ë“œì¼ë•Œ ì£¼ë¡œ ìœ íš¨)
            toggleIndicators(mode);

            // Analysis ê²°ê³¼ í…ìŠ¤íŠ¸ ë Œë”ë§
            document.getElementById('chartTitle').innerText = `${data.analysis.ticker} ì¼ë´‰ ${titleSuffix}`;

            // ì ìˆ˜ì— ë”°ë¥¸ ìƒìƒ ë³€ê²½ ë¡œì§
            const scoreEl = document.getElementById('scoreValue');
            const score = data.analysis.score;
            scoreEl.innerText = score;
            if (score >= 80) scoreEl.style.color = 'var(--success-color)';
            else if (score >= 50) scoreEl.style.color = 'var(--warning-color)';
            else scoreEl.style.color = 'var(--danger-color)';

            const signalsHtml = data.analysis.signals.map(s => `<li class="signal-item">${s}</li>`).join('');
            document.getElementById('signalList').innerHTML = signalsHtml;

            // ìˆ˜ê¸‰ í…Œì´ë¸” ë Œë”ë§ ë° ê³µë§¤ë„ ì”ê³  ì¶”ê°€
            const supplyObj = data.analysis.supply_data || {};
            const supplyData = supplyObj.investor_trend || [];
            const shortBalance = supplyObj.short_balance || {};
            const supplyContainer = document.getElementById('supplyContainer');

            if (supplyData && supplyData.length > 0) {
                supplyContainer.style.display = 'block';
                const tbody = document.querySelector('#supplyTable tbody');
                // ìµœì‹  ë‚ ì§œê°€ ìœ„ë¡œ ì˜¤ë„ë¡ ë’¤ì§‘ê¸°
                const reversedSupply = [...supplyData].reverse();
                const html = reversedSupply.map(row => {
                    const fmt = (val) => {
                        if (val === undefined || val === null) return '-';
                        const str = val.toLocaleString();
                        return val > 0 ? `<span class="text-success">+${str}</span>`
                            : (val < 0 ? `<span class="text-danger">${str}</span>` : '<span style="color:#666">0</span>');
                    };
                    return `
                        <tr>
                            <td>${row.date.slice(5)}</td>
                            <td>${fmt(row.individual_net)}</td>
                            <td>${fmt(row.foreign_net)}</td>
                            <td>${fmt(row.institution_net)}</td>
                        </tr>
                    `;
                }).join('');
                tbody.innerHTML = html;

                // ê³µë§¤ë„ ì”ê³  ì •ë³´ í‘œì¶œ
                const shortInfo = document.getElementById('shortBalanceInfo');
                if (shortBalance.balance_qty !== undefined && shortBalance.balance_qty > 0) {
                    const ratio = shortBalance.balance_ratio;
                    let warningHtml = ratio >= 5 ? `<span class="text-danger">âš ï¸ ìœ„í—˜ (${ratio}%)</span>`
                        : (ratio >= 2 ? `<span style="color:var(--warning-color)">ì£¼ì˜ (${ratio}%)</span>` : `<span class="text-success">ì•ˆì „ (${ratio}%)</span>`);

                    shortInfo.innerHTML = `ê³µë§¤ë„ ì”ê³ : <b>${shortBalance.balance_qty.toLocaleString()}ì£¼</b> | ë¹„ì¤‘: ${warningHtml}`;
                } else {
                    shortInfo.innerHTML = '';
                }
            } else {
                supplyContainer.style.display = 'none';
            }

            document.getElementById('macroStatus').innerText = data.analysis.macro_status;

            // ì°¨íŠ¸ í¬ê¸° ë° ì‹œì  ë§ì¶¤ (ìµœê·¼ 150ì¼ ì •ë„ë¡œ í™•ëŒ€)
            chart.timeScale().fitContent();
        }

        function toggleIndicators(currentMode = 'swing') {
            if (!chart) return;
            const showEma = document.getElementById('toggleEma').checked;
            const showShort = document.getElementById('toggleShort').checked;
            const showMacd = document.getElementById('toggleMacd').checked;
            const showVcp = document.getElementById('toggleVcp').checked;

            if (currentMode === 'swing') {
                ema21Series.applyOptions({ visible: showEma });
                ema50Series.applyOptions({ visible: showEma });
                ema200Series.applyOptions({ visible: showEma });
            }

            const visibleMarkers = currentMarkers.filter(m => {
                if (currentMode !== 'swing') return true; // ë‹¤ë¥¸ ëª¨ë“œì—ì„œëŠ” ë§ˆì»¤ í•„í„°ë§ ì•ˆí•¨
                if (m.type === 'short') return showShort;
                if (m.type === 'macd') return showMacd;
                if (m.type === 'vcp') return showVcp;
                return true;
            });

            candleSeries.setMarkers(visibleMarkers);
        }

        // ì°½ í¬ê¸° ì¡°ì ˆ ì‹œ ì°¨íŠ¸ ë¦¬ì‚¬ì´ì§• ëŒ€ì‘
        window.addEventListener('resize', () => {
            if (chart) {
                chart.applyOptions({
                    width: document.getElementById('tvchart').clientWidth
                });
            }
        });

        // ==========================================
        // ë™ì  ê°€ì´ë“œë¶ (ì§€í‘œ ì„¤ëª…ì„œ) ë Œë”ë§
        // ==========================================
        const guideData = {
            'swing': `
                <h4 style="color:#ffaa00; margin-bottom: 12px; font-size: 1.1rem;">ğŸ”¥ ìŠ¤ìœ™ ëˆŒë¦¼ëª© ëª¨ë“œ (VCP / MACD)</h4>
                <p style="margin-bottom: 20px; color: var(--text-secondary);">ë‹¬ë¦¬ëŠ” ë§ì— ì˜¬ë¼íƒ€ë˜, ë§ì´ ì ê¹ ìˆ¨ì„ ê³ ë¥´ë©° ì‰¬ì–´ê°€ëŠ” 'ëˆŒë¦¼ëª©' ìë¦¬ë¥¼ ë…¸ë¦½ë‹ˆë‹¤.</p>
                
                <h5 style="color:#b300ff; margin-bottom: 8px;">ğŸŸ£ VCP ìŠ¤ìœ™ (ë³€ë™ì„± ì¶•ì†Œ íŒ¨í„´)</h5>
                <ul style="margin-bottom: 20px; padding-left: 20px; color: var(--text-secondary);">
                    <li style="margin-bottom: 6px;"><strong>ì›ë¦¬:</strong> ì£¼ê°€ê°€ ìœ„ì•„ë˜ë¡œ í­ì´ ì¢ì•„ì§€ë©° ì”ì”í•´ì§‘ë‹ˆë‹¤. í­í’ì „ì•¼ì²˜ëŸ¼ ì‚¬ëŒë“¤ì˜ ê´€ì‹¬ì´ ëŠê²¨ ê±°ë˜ëŒ€ê¸ˆë„ ëš ëŠê¹ë‹ˆë‹¤(ê³ ê°ˆ). ìŠ¤í”„ë§ì„ ê½‰ ëˆ„ë¥´ê³  ì—ë„ˆì§€ë¥¼ ì‘ì¶•í•˜ëŠ” ìƒíƒœ.</li>
                    <li><strong>íƒ€ì :</strong> ì „ë‚ ê¹Œì§€ ê±°ë˜ëŒ€ê¸ˆì´ ì™„ì „íˆ ë°”ë‹¥ë‚˜ë©°('ê³ ê°ˆ') ìˆ¨ì„ ì£½ì´ë˜ ì£¼ì‹ì´, 21ì¼ì„ (ìƒëª…ì„ ) ê·¼ì²˜ì—ì„œ ë‹¤ì‹œ ê³ ê°œë¥¼ ë“¤ë©° ì˜ˆì˜ê²Œ ì–‘ë´‰ìœ¼ë¡œ ë°˜ë“±ì„ ì‹œì‘í•˜ëŠ” ì‹œì . í­ë°œ ì§ì „ ê¸¸ëª© ì„ ì .</li>
                </ul>

                <h5 style="color:#00b8ff; margin-bottom: 8px;">ğŸ”µ MACD ìŠ¤ìœ™ (ëª¨ë©˜í…€ ë°˜ì „)</h5>
                <ul style="margin-bottom: 20px; padding-left: 20px; color: var(--text-secondary);">
                    <li style="margin-bottom: 6px;"><strong>ì›ë¦¬:</strong> ê±°ëŒ€í•œ ì¶”ì„¸(200ì¼ì„ ) ìœ„ì—ì„œ ì¡°ì •ì„ ë°›ë˜ ì£¼ì‹ì˜ í•˜ë½ ê°€ì†ë„ê°€ ë©ˆì¶”ê³  ê³ ê°œë¥¼ ë“œëŠ”(ìƒìŠ¹ ëª¨ë©˜í…€ ë°˜ì „) êµ¬ê°„ì…ë‹ˆë‹¤.</li>
                    <li><strong>íƒ€ì :</strong> ì£¼ê°€ê°€ 21ì¼ì„  ê·¼ì²˜ë¡œ ì˜ˆì˜ê²Œ ëˆŒë¦° ì§í›„, í•˜ë½ ì—ë„ˆì§€ê°€ ìƒìŠ¹ ì—ë„ˆì§€ë¡œ ë°˜ì „ë˜ëŠ” ì²« í„´ì–´ë¼ìš´ë“œ ì§€ì .</li>
                </ul>

                <h5 style="color:#00ff88; margin-bottom: 8px;">ğŸŸ© ë‹¨ê¸° ë°˜ë“± íƒ€ì </h5>
                <ul style="margin-bottom: 5px; padding-left: 20px; color: var(--text-secondary);">
                    <li style="margin-bottom: 6px;"><strong>ì›ë¦¬:</strong> ë…¸ë€ìƒ‰ 21ì¼ì„ (ë‹¨ê¸° ìƒëª…ì„ )ì— ë¶€ë”ªíˆê±°ë‚˜ ì‚´ì§ ê¹¼ë‹¤ê°€ ë‹¤ì‹œ ìœ„ë¡œ íŠ•ê²¨ ì˜¬ë¼ì˜¤ëŠ” ê¸°ìˆ ì  'ë°˜ì‘ìš©'ë§Œ ë…¸ë¦½ë‹ˆë‹¤.</li>
                    <li><strong>ëŒ€ì²˜:</strong> ë°©ë§ì´ë¥¼ ì§§ê²Œ ì¡ê³  ë©°ì¹  ë§Œì— ì€í–‰ ì´ì ì •ë„ë§Œ ì™ ë¹¼ë¨¹ê³  ë„ë§ê°€ëŠ” ë‹¨íƒ€ìš©ìœ¼ë¡œ ì í•©í•©ë‹ˆë‹¤.</li>
                </ul>
            `,
            'atr': `
                <h4 style="color:#ff3366; margin-bottom: 12px; font-size: 1.1rem;">ğŸš¨ ATR ê³¼ì—´/ì¹¨ì²´ íŒë…ëŒ€</h4>
                <p style="margin-bottom: 20px; color: var(--text-secondary);">ì£¼ê°€ê°€ ì •ìƒ ê¶¤ë„ë¥¼ ì´íƒˆí•´ì„œ ë„ˆë¬´ ë¹„ì •ìƒì ìœ¼ë¡œ ê¸‰ë“±í–ˆê±°ë‚˜ í­ë½í–ˆëŠ”ì§€ë¥¼ íŒë‹¨í•´ ì£¼ëŠ” "ê³¼ì† ë‹¨ì† ì¹´ë©”ë¼"ì…ë‹ˆë‹¤. (ì˜¤ì§ 50ì¼ íŒŒë€ì„  ê¸°ì¤€)</p>

                <h5 style="color:#ffaa00; margin-bottom: 8px;">ğŸ“ ATR ì´ë€ ë¬´ì—‡ì¸ê°€ìš”?</h5>
                <p style="margin-bottom: 20px; color: var(--text-secondary);">ì£¼ì‹ì´ í•˜ë£¨ì— ë³´í†µ ìœ„ì•„ë˜ë¡œ ì–¼ë§Œí¼ ì›€ì§ì´ëŠ”ì§€ í‰ê· ì„ ë‚¸ ì²™ë„ì…ë‹ˆë‹¤. í‰ì†Œ í•˜ë£¨ 100ì› ì›€ì§ì´ë˜ ì£¼ì‹ì´ ê°‘ìê¸° 700ì›ì–´ì¹˜ í­ë“±í•˜ë©´ "7 ATR ì˜¤ë²„ìŠˆíŒ…"ìœ¼ë¡œ ê°•ë ¥í•˜ê²Œ ê²½ê³ í•©ë‹ˆë‹¤.</p>

                <h5 style="color:#ff3366; margin-bottom: 8px;">ğŸ”´ ë¹¨ê°„ ì  (7.0 ATR ì´ìƒ : ê³¼ì—´ í”¼ë‚ ë ˆ)</h5>
                <ul style="margin-bottom: 20px; padding-left: 20px; color: var(--text-secondary);">
                    <li style="margin-bottom: 6px;"><strong>ìƒíƒœ:</strong> 50ì¼ì„ ìœ¼ë¡œë¶€í„° í•˜ëŠ˜ ì € ìœ„ë¡œ ì¹˜ì†Ÿì•„ ê³ ë¬´ì¤„ì´ íŒ½íŒ½í•˜ê²Œ ëŠ˜ì–´ë‚˜ë‹¤ ëª»í•´ ëŠì–´ì§€ê¸° ì§ì „!</li>
                    <li><strong>ëŒ€ì²˜:</strong> ì ˆëŒ€ ì‹ ê·œ ë§¤ìˆ˜ ê¸ˆì§€! ì´ë¯¸ ì‚° ì‚¬ëŒë“¤ì˜ ìˆ˜ìµ ì¶•ì œ êµ¬ê°„ì´ë©°, ì¤‘ë ¥ì˜ ë²•ì¹™ì— ì˜í•´ íŒ¨ë‹‰ ì…€ í­ë½ ì „ì•¼ì…ë‹ˆë‹¤.</li>
                </ul>

                <h5 style="color:#00ff88; margin-bottom: 8px;">ğŸŸ¢ ì´ˆë¡ ì  (-7.0 ATR ì´í•˜ : ì¹¨ì²´ ë‚™ì£¼)</h5>
                <ul style="margin-bottom: 5px; padding-left: 20px; color: var(--text-secondary);">
                    <li style="margin-bottom: 6px;"><strong>ìƒíƒœ:</strong> 50ì¼ì„ ì—ì„œ í•œì°¸ ë–¨ì–´ì ¸ ì§€í•˜ ì•”ë°˜ìˆ˜ê¹Œì§€ íˆ¬ë§¤ê°€ ìŸì•„ì§„ ê³µí¬ì˜ êµ¬ê°„!</li>
                    <li><strong>ëŒ€ì²˜:</strong> ìƒí ì´ìŠˆê°€ ì—†ë‹¤ë©´ ìš©ê¸° ìˆëŠ” ì°¨íŠ¸ íŠ¸ë ˆì´ë”ë“¤ì˜ Vì ë¡œì¼“ ë°˜ë“±(ë‚™ì£¼) íƒ€ì ì…ë‹ˆë‹¤.</li>
                </ul>
            `,
            'fibonacci': `
                <h4 style="color:#00b8ff; margin-bottom: 12px; font-size: 1.1rem;">ğŸ“ í”¼ë³´ë‚˜ì¹˜ ë˜ëŒë¦¼ ë¶„ì„</h4>
                <p style="margin-bottom: 20px; color: var(--text-secondary);">ë°”ë‹¥ì—ì„œ ê¼­ëŒ€ê¸°ê¹Œì§€ ì‚°ì„ ë§Œë“  ì£¼ì‹ì´ ë–¨ì–´ì§ˆ ë•Œ, ëŒ€ì²´ ì–´ë””ì¯¤ì—ì„œ ë¸Œë ˆì´í¬ê°€ ê±¸ë¦´ì§€ ìì—°ì˜ í™©ê¸ˆë¹„ìœ¨ ì„ ì„ ê·¸ì–´ ì˜ˆì¸¡í•´ ë´…ë‹ˆë‹¤.</p>

                <h5 style="color:#ffaa00; margin-bottom: 8px;">ğŸš€ 0.236 (23.6%) êµ¬ì—­</h5>
                <p style="margin-bottom: 15px; color: var(--text-secondary); line-height: 1.5;">ê³ ì ì—ì„œ 23.6% ë–¨ì–´ì¡ŒëŠ”ë°ë„ ë‹¤ë“¤ "ì‹¸ë‹¤!"ë©° í—ˆê²ì§€ê² ë‹¤ì‹œ ì‚¬ë“¤ì´ëŠ” êµ¬ì—­ì…ë‹ˆë‹¤.<br>ë§¤ìˆ˜ì„¸ê°€ ì••ë„ì ìœ¼ë¡œ ê°•í•œ <strong>'ì´ˆê¸‰ë“± ëŒ€ì¥ì£¼'</strong>ë§Œì´ ì´ ì–•ì€ ì„ ì—ì„œ ë²„í‹°ë©° ì „ê³ ì ì„ ë‹¤ì‹œ ëš«ìŠµë‹ˆë‹¤.</p>

                <h5 style="color:#eab308; margin-bottom: 8px;">ğŸ“ˆ 0.382 (38.2%) êµ¬ì—­</h5>
                <p style="margin-bottom: 15px; color: var(--text-secondary); line-height: 1.5;">ê°€ì¥ ê±´ê°•í•˜ê³  ë² ìŠ¤íŠ¸ì…€ëŸ¬ ê°™ì€ ìë¦¬ì…ë‹ˆë‹¤.<br>100ì¸µì—ì„œ 62ì¸µ ì •ë„(38ì¸µ í•˜ë½)ë¡œ ëˆŒë¦°, ì „ë¬¸ê°€ë“¤ì´ ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ì •ì„ì ì¸ 1ì°¨ ë§¤ìˆ˜(ìŠ¤ìœ™) íƒ€ì !</p>

                <h5 style="color:#a855f7; margin-bottom: 8px;">â¸ï¸ 0.500 (50.0%) êµ¬ì—­</h5>
                <p style="margin-bottom: 15px; color: var(--text-secondary); line-height: 1.5;">ë§ ê·¸ëŒ€ë¡œ ë°˜í† ë§‰(ë°˜ê°’ ë°”ê²ì„¸ì¼)ì´ ëœ ìë¦¬ì…ë‹ˆë‹¤.<br>ì˜¤ë¥´ë ¤ëŠ” ìì™€ ë‚´ë¦¬ë ¤ëŠ” ì ì‚¬ì´ì˜ ê°€ì¥ ì¹˜ì—´í•œ í•‘í ì‹¸ì›€ì´ ë²Œì–´ì§€ëŠ” ê³µë°©ì „ êµ¬ì—­ì…ë‹ˆë‹¤.</p>

                <h5 style="color:#00b8ff; margin-bottom: 8px;">ğŸ‘€ 0.618 (61.8%) ìµœí›„ì˜ ë§ˆì§€ë…¸ì„ </h5>
                <p style="margin-bottom: 0px; color: var(--text-secondary); line-height: 1.5;">ì¶”ì„¸ë¼ê³  ìš°ê¸°ê¸° ìœ„í•œ ê°€ì¥ ê¹Šê³  ìœ„í—˜í•œ ë§ˆì§€ë…¸ì„ ì…ë‹ˆë‹¤.<br>ì—¬ê¸°ì„œ ê°„ì‹ íˆ ë°˜ë“±í•´ì£¼ë©´ 'ê¹Šì€ ì¡°ì •'ìœ¼ë¡œ ì¸ì •ë˜ì§€ë§Œ, ë§Œì•½ í•˜ë°©ìœ¼ë¡œ ëš«ë¦°ë‹¤ë©´ <strong>'ëŒ€ì„¸ í•˜ë½ íŒŒë™ì˜ ì‹œì‘'</strong>ìœ¼ë¡œ ëŒ€í”¼í•´ì•¼ í•©ë‹ˆë‹¤.</p>
            `
        };

        const modeSelect = document.getElementById('modeSelect');
        const guideContent = document.getElementById('guideContent');
        const guideToggleBtn = document.getElementById('guideToggleBtn');
        let isGuideOpen = true;

        function updateGuide() {
            if (!modeSelect) return;
            const mode = modeSelect.value;
            guideContent.innerHTML = guideData[mode];
        }

        function toggleGuide() {
            if (isGuideOpen) {
                guideContent.style.display = 'none';
                guideToggleBtn.innerText = 'í¼ì¹˜ê¸° ğŸ”½';
                isGuideOpen = false;
            } else {
                guideContent.style.display = 'block';
                guideToggleBtn.innerText = 'ì ‘ê¸° ğŸ”¼';
                isGuideOpen = true;
            }
        }

        if (modeSelect) {
            modeSelect.addEventListener('change', updateGuide);
            updateGuide(); // ì´ˆê¸° ë Œë”ë§
        }
    </script>
</body>

</html>