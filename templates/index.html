<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Quant Analyst | 스윙 트레이딩 대시보드</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Lightweight Charts (TradingView) -->
    <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>AI Quant Analyst</h1>
            <div style="color: var(--text-secondary); font-size: 0.9rem;">v1.0 (미시적 스윙 뷰어)</div>
        </header>

        <section class="search-section">
            <input type="text" id="tickerInput" placeholder="종목 코드를 입력하세요 (예: 005930, 035420, TSLA)..."
                autocomplete="off" onkeypress="if(event.key === 'Enter') analyzeStock()">
            <button onclick="analyzeStock()">분석 시작 🚀</button>
        </section>

        <div id="loadingIndicator" class="loading">
            데이터 우주를 스캔하는 중... 📡
        </div>

        <main id="dashboardGrid" class="dashboard-grid">
            <!-- Left col: Chart -->
            <div class="card">
                <h2 style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <span id="chartTitle">TSLA 일봉 차트</span>
                    <div style="display: flex; gap: 0.8rem; font-size: 0.85rem; color: var(--text-secondary);">
                        <label style="cursor: pointer;"><input type="checkbox" id="toggleEma" checked
                                onchange="toggleIndicators()"> EMA 라인</label>
                        <label style="cursor: pointer;"><input type="checkbox" id="toggleShort" checked
                                onchange="toggleIndicators()"> 🟩 단기</label>
                        <label style="cursor: pointer;"><input type="checkbox" id="toggleMacd" checked
                                onchange="toggleIndicators()"> 🔵 MACD</label>
                        <label style="cursor: pointer;"><input type="checkbox" id="toggleVcp" checked
                                onchange="toggleIndicators()"> 🟣 VCP</label>
                    </div>
                </h2>
                <div id="tvchart" class="chart-container"></div>
            </div>

            <!-- Right col: Analysis -->
            <div class="analysis-sidebar">
                <div class="card score-box">
                    <h3>현재 기술적 스윙 점수</h3>
                    <div id="scoreValue" class="score-circle">--</div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">100점 만점 기준</div>
                </div>

                <div class="card" style="flex: 1;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--text-secondary); letter-spacing: 1px;">알고리즘 분석의견</h3>
                    <ul id="signalList" class="signal-list">
                        <!-- Signals will be injected here -->
                    </ul>

                    <div class="macro-section" id="macroStatus">
                        거시적 상태: 대기중...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let chart = null;
        let candleSeries = null;
        let ema21Series = null;
        let ema50Series = null;
        let ema200Series = null;
        let currentMarkers = [];

        function initChart() {
            const chartContainer = document.getElementById('tvchart');
            // 이미 차트가 있다면 초기화
            if (chart !== null) {
                chart.remove();
            }

            // 차트 껍데기(UI) 생성
            chart = LightweightCharts.createChart(chartContainer, {
                layout: {
                    background: { type: 'solid', color: '#151a25' },
                    textColor: '#94a3b8',
                },
                grid: {
                    vertLines: { color: '#1e293b' },
                    horzLines: { color: '#1e293b' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#1e293b',
                },
                timeScale: {
                    borderColor: '#1e293b',
                },
            });

            // 캔들차트, 이평선 시리즈 추가 준비
            candleSeries = chart.addCandlestickSeries({
                upColor: '#00ff88',
                downColor: '#ff3366',
                borderVisible: false,
                wickUpColor: '#00ff88',
                wickDownColor: '#ff3366',
            });

            ema21Series = chart.addLineSeries({
                color: '#ffaa00',
                lineWidth: 2,
                title: 'EMA 21',
            });

            ema50Series = chart.addLineSeries({
                color: '#00b8ff',
                lineWidth: 1,
                title: 'EMA 50',
            });

            ema200Series = chart.addLineSeries({
                color: '#94a3b8',
                lineWidth: 1,
                title: 'EMA 200',
            });
        }

        async function analyzeStock() {
            const ticker = document.getElementById('tickerInput').value.trim();
            if (!ticker) return alert('티커를 입력해주세요!');

            // UI 변경 (로딩)
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('dashboardGrid').classList.remove('visible');

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker: ticker })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '알 수 없는 서버 오류');
                }

                // UI 업데이트 (결과)
                updateDashboard(data);

            } catch (error) {
                alert(error.message);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        function updateDashboard(data) {
            // 대시보드 먼저 스르륵 켜기 (크기 계산을 위해)
            document.getElementById('dashboardGrid').classList.add('visible');

            // 차트 렌더링
            initChart();

            const mainData = data.chart_data.map(d => ({
                time: d.time, open: d.open, high: d.high, low: d.low, close: d.close
            }));
            candleSeries.setData(mainData);

            // 이동평균선 데이터 맵핑
            const ema21Data = data.chart_data.filter(d => d.ema_21 !== null).map(d => ({ time: d.time, value: d.ema_21 }));
            const ema50Data = data.chart_data.filter(d => d.ema_50 !== null).map(d => ({ time: d.time, value: d.ema_50 }));
            const ema200Data = data.chart_data.filter(d => d.ema_200 !== null).map(d => ({ time: d.time, value: d.ema_200 }));

            if (ema21Data.length > 0) ema21Series.setData(ema21Data);
            if (ema50Data.length > 0) ema50Series.setData(ema50Data);
            if (ema200Data.length > 0) ema200Series.setData(ema200Data);

            // 매수 타점 마커(화살표) 생성 로직
            currentMarkers = [];
            data.chart_data.forEach(d => {
                if (d.buy_swing_vcp) {
                    currentMarkers.push({
                        time: d.time, position: 'belowBar', color: '#b300ff', shape: 'arrowUp', text: 'VCP 스윙', type: 'vcp'
                    });
                } else if (d.buy_swing_macd) {
                    currentMarkers.push({
                        time: d.time, position: 'belowBar', color: '#00b8ff', shape: 'arrowUp', text: 'MACD 스윙', type: 'macd'
                    });
                } else if (d.buy_short) {
                    currentMarkers.push({
                        time: d.time, position: 'belowBar', color: '#00ff88', shape: 'arrowUp', text: '단기 진입', type: 'short'
                    });
                }
            });

            // 토글 상태에 맞춰 초기 마커 렌더링
            toggleIndicators();

            // Analysis 결과 텍스트 렌더링
            document.getElementById('chartTitle').innerText = `${data.analysis.ticker} 일봉 스윙타점 분석`;

            // 점수에 따른 생상 변경 로직
            const scoreEl = document.getElementById('scoreValue');
            const score = data.analysis.score;
            scoreEl.innerText = score;
            if (score >= 80) scoreEl.style.color = 'var(--success-color)';
            else if (score >= 50) scoreEl.style.color = 'var(--warning-color)';
            else scoreEl.style.color = 'var(--danger-color)';

            const signalsHtml = data.analysis.signals.map(s => `<li class="signal-item">${s}</li>`).join('');
            document.getElementById('signalList').innerHTML = signalsHtml;

            document.getElementById('macroStatus').innerText = data.analysis.macro_status;

            // 차트 크기 및 시점 맞춤 (최근 150일 정도로 확대)
            chart.timeScale().fitContent();
        }

        function toggleIndicators() {
            if (!chart) return;
            const showEma = document.getElementById('toggleEma').checked;
            const showShort = document.getElementById('toggleShort').checked;
            const showMacd = document.getElementById('toggleMacd').checked;
            const showVcp = document.getElementById('toggleVcp').checked;

            ema21Series.applyOptions({ visible: showEma });
            ema50Series.applyOptions({ visible: showEma });
            ema200Series.applyOptions({ visible: showEma });

            const visibleMarkers = currentMarkers.filter(m => {
                if (m.type === 'short') return showShort;
                if (m.type === 'macd') return showMacd;
                if (m.type === 'vcp') return showVcp;
                return true;
            });

            candleSeries.setMarkers(visibleMarkers);
        }

        // 창 크기 조절 시 차트 리사이징 대응
        window.addEventListener('resize', () => {
            if (chart) {
                chart.applyOptions({
                    width: document.getElementById('tvchart').clientWidth
                });
            }
        });
    </script>
</body>

</html>